name: Create Oxidizium

on:
  workflow_dispatch :

env:
  CARGO_TERM_COLOR: always

jobs:
  rust_linux_x86:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: crusty-pie/toolchain@main
      with:
        toolchain: nightly
        target: aarch64-linux-android
        profile: minimal
        override: true
    
    - name: Build x86
      run: |
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/28.0.5334843" >> $GITHUB_ENV
        cd native
        cat <<EOF > ./config.toml
        [target.aarch64-linux-android]
        ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-ar"
        linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++"
        EOF
        rustup target add aarch64-linux-android
        cargo build --target aarch64-linux-android --release -r
    - name: Rename
      run: mv native/target/release/liboxidizium.so liboxidizium_linux_x86.so
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: liboxidizium_linux_x86.so
        path: liboxidizium_linux_x86.so
    - name: Upload C Header File
      uses: actions/upload-artifact@v4
      with:
        name: lib.h
        path: native/lib.h

  oxidizium:
    needs: [rust_linux_x86]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download Rust binaries
      uses: actions/download-artifact@v4
      with:
        path: /home/runner/work/Oxidizium/Oxidizium
        merge-multiple: true

    - name: Remove Artifact Binaries
      uses: geekyeggo/delete-artifact@v5
      with:
        name: |
          liboxidizium_linux_x86.so
          lib.h
        failOnError: false

    - name: Make Gradlew Executable
      run: chmod +x gradlew
    - name: Validate the Gradle Wrapper
      uses: gradle/actions/wrapper-validation@v4
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: 22

    - name: Compile Oxidizium Projects
      run: ./gradlew :testMod:build --no-daemon

    - name: Upload Oxidizium
      uses: actions/upload-artifact@v4
      with:
        name: Oxidizium
        path: |
          oxidizium/build/libs/*.jar
          !oxidizium/build/libs/*-sources.jar

    - name: Upload Oxidizium Tester
      uses: actions/upload-artifact@v4
      with:
        name: Oxidizium-Tester
        path: |
          testMod/build/libs/*.jar
          !testMod/build/libs/*-sources.jar
